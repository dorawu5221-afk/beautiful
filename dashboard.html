<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å ±åç¾æ³å„€è¡¨æ¿ - æ•æ·æ€ç¶­ç ”è¨æœƒ</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Inter (é è¨­) ä¸¦ç¢ºä¿ä¸­æ–‡å­—é«”é¡¯ç¤ºæ­£å¸¸ */
        html { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        
        /* å®šç¾©å¤¢å¹»æ¼¸è®ŠèƒŒæ™¯ */
        .dreamy-gradient {
            background-color: #f7f3ff; /* Fallback color */
            background-image: linear-gradient(to bottom right, #e0f7fa, #fce4ec, #f3e5f5);
            min-height: 100vh;
        }

        /* å„€è¡¨æ¿å¡ç‰‡é¢¨æ ¼ */
        .dashboard-card {
            background-color: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px rgba(100, 0, 150, 0.1);
        }
        
        /* è·ç¨±åœ–è¡¨å°ˆç”¨ï¼šç¢ºä¿æ»¾å‹•å’Œå¯è¦–æ€§ */
        #titleChartContainer {
            overflow-y: auto; /* å…è¨±å‚ç›´æ»¾å‹• */
            max-height: 400px; /* é™åˆ¶åœ–è¡¨æœ€å¤§é«˜åº¦ */
        }
    </style>
</head>
<body class="dreamy-gradient p-4 md:p-8">

    <!-- å„€è¡¨æ¿å®¹å™¨ -->
    <div id="dashboard-container" class="max-w-6xl mx-auto">
        
        <!-- æ¨™é¡Œå€å¡Š -->
        <header class="text-center mb-10 p-6 bg-white bg-opacity-80 rounded-3xl shadow-xl backdrop-blur-sm">
            <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600 mb-2">
                æ•æ·æ€ç¶­ç ”è¨æœƒ - å ±åç¾æ³å„€è¡¨æ¿
            </h1>
            <p class="text-lg font-semibold text-gray-700">
                å³æ™‚æ•¸æ“šåˆ†æ (ä¸Šæ¬¡æ›´æ–°æ™‚é–“: <span id="lastUpdated" class="font-normal text-purple-500">è¼‰å…¥ä¸­...</span>)
            </p>
            <p class="text-sm text-red-500 mt-2">
                <!-- æç¤ºå·²ç§»é™¤ï¼Œå› ç‚º URL å·²è¨­å®š -->
            </p>
        </header>
        
        <!-- ğŸ’¡ å·²æ›¿æ›ç‚ºæ‚¨æä¾›çš„ Web App URL -->
        <script>
            // ä¿®æ­£ URL ä¸­çš„æ‹¼å¯«éŒ¯èª¤ï¼Œç¢ºä¿èˆ‡æ‚¨æä¾›çš„ç¶²å€ä¸€è‡´
            const DASHBOARD_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyyhJHROihrtShavm_fhfgBKi66UtzN9Bfk5RuulFBBaOo5CE4utWaWGCLYP6bTSLRbog/exec'; 
        </script>

        <!-- æ•¸æ“šç¸½è¦½ (ä¸‰æ ¼å¡ç‰‡) -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            
            <!-- ç¸½å ±åäººæ•¸ -->
            <div class="dashboard-card p-6 rounded-2xl shadow-lg border-b-4 border-purple-500">
                <p class="text-sm font-medium text-gray-500">ç¸½å ±åäººæ•¸</p>
                <p id="totalCount" class="text-5xl font-extrabold text-purple-600 mt-1">...</p>
                <div class="flex items-center text-sm text-gray-400 mt-2">
                    <svg class="w-4 h-4 mr-1 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-5a3 3 0 01-3-3V9a2 2 0 00-2-2h-3L9 4m0 0a2 2 0 00-2-2h-3v7l3 3m0 0h5m-5 0v5m3-3v3m-3-3v3m3 3h5m-5 0v3m3-3v3"></path></svg>
                    <span>æ‰€æœ‰å–®ä½åˆè¨ˆ</span>
                </div>
            </div>

            <!-- èŒ¶æ°´é»å¿ƒéœ€æ±‚ -->
            <div class="dashboard-card p-6 rounded-2xl shadow-lg border-b-4 border-pink-500">
                <p class="text-sm font-medium text-gray-500">èŒ¶æ°´é»å¿ƒéœ€æ±‚äººæ•¸ (æ˜¯)</p>
                <p id="refreshmentsCount" class="text-5xl font-extrabold text-pink-600 mt-1">...</p>
                <div class="flex items-center text-sm text-gray-400 mt-2">
                    <svg class="w-4 h-4 mr-1 text-pink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span>é¤é»æº–å‚™åƒè€ƒæ•¸æ“š</span>
                </div>
            </div>

            <!-- å¹³å‡å ±åé€²åº¦ (Placeholder) -->
            <div class="dashboard-card p-6 rounded-2xl shadow-lg border-b-4 border-teal-500">
                <p class="text-sm font-medium text-gray-500">å¹³å‡å ±åé€Ÿåº¦</p>
                <p id="averageSpeed" class="text-5xl font-extrabold text-teal-600 mt-1">N/A</p>
                <div class="flex items-center text-sm text-gray-400 mt-2">
                    <svg class="w-4 h-4 mr-1 text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>å ±åé–‹æ”¾è‡³ä»Šå¹³å‡æ¯æ—¥å ±åæ•¸</span>
                </div>
            </div>
        </section>

        <!-- åœ–è¡¨èˆ‡åˆ—è¡¨å€å¡Š -->
        <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">

            <!-- è·ç¨±åˆ†ä½ˆåœ– -->
            <div class="dashboard-card p-6 rounded-2xl shadow-lg space-y-4">
                <h2 class="text-xl font-bold text-gray-700 border-b pb-2">ğŸ“Š è·ç¨±åˆ†ä½ˆ</h2>
                <div id="titleChartContainer" class="min-h-[250px] flex flex-col justify-center items-center">
                    <!-- åœ–è¡¨å°‡ç”± JS å‹•æ…‹ç”Ÿæˆ -->
                    <p id="titleChartLoading" class="text-gray-500">è¼‰å…¥è·ç¨±æ•¸æ“šä¸­...</p>
                </div>
            </div>

            <!-- æœ€æ–°å ±ååå–® -->
            <div class="dashboard-card p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">ğŸ“œ æœ€æ–° 5 ç­†å ±å</h2>
                <ul id="latestRegistrations" class="space-y-3">
                    <li class="text-gray-500">è¼‰å…¥æœ€æ–°åå–®ä¸­...</li>
                </ul>
                <p id="latestRegistrationError" class="text-red-500 hidden mt-2 text-sm">ç„¡æ³•è¼‰å…¥æœ€æ–°åå–®ã€‚</p>
            </div>
            
            <!-- æœƒå‰æå•åˆ—è¡¨ -->
            <div class="lg:col-span-2 dashboard-card p-6 rounded-2xl shadow-lg">
                <h2 class="text-xl font-bold text-gray-700 border-b pb-2 mb-4">ğŸ’¬ æœƒå‰æå• / ç—›é»è’é›†</h2>
                <div id="preQuestionList" class="space-y-4">
                    <p class="text-gray-500">è¼‰å…¥æœƒå‰æå•ä¸­...</p>
                </div>
                <p id="preQuestionError" class="text-red-500 hidden mt-2 text-sm">ç„¡æ³•è¼‰å…¥æå•ã€‚</p>
            </div>

        </section>
        
    </div>

    <!-- JavaScript é‚è¼¯ -->
    <script>
        // === æ•¸æ“šè™•ç†èˆ‡æ¸²æŸ“é‚è¼¯ ===

        /**
         * è½‰æ›æ—¥æœŸæ™‚é–“æ ¼å¼
         * @param {string | Date} dateValue - æ—¥æœŸå€¼
         * @returns {string} æ ¼å¼åŒ–å¾Œçš„æ—¥æœŸå­—ä¸²
         */
        function formatDateTime(dateValue) {
            try {
                const date = new Date(dateValue);
                if (isNaN(date)) return 'N/A';
                
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                
                return `${year}/${month}/${day} ${hours}:${minutes}`;
            } catch (e) {
                return 'N/A';
            }
        }

        /**
         * è¨ˆç®—å ±åæ•¸æ“šçš„çµ±è¨ˆè³‡è¨Š
         * @param {Array<Object>} data - åŸå§‹å ±åæ•¸æ“šé™£åˆ—
         * @returns {Object} çµ±è¨ˆçµæœ
         */
        function calculateStats(data) {
            const stats = {
                total: data.length,
                refreshmentsYes: 0,
                titleCounts: {},
                latestEntries: data.slice(0, 5), // å–å‰äº”ç­†è³‡æ–™
                questions: [],
            };

            data.forEach(item => {
                // 1. èŒ¶æ°´é»å¿ƒè¨ˆç®—
                if (item.refreshments === 'æ˜¯') {
                    stats.refreshmentsYes++;
                }

                // 2. è·ç¨±åˆ†ä½ˆè¨ˆç®—
                // ç¢ºä¿è·ç¨±éç©ºï¼Œè‹¥ç©ºå‰‡ä½¿ç”¨ã€Œæœªå¡«å¯«ã€
                const title = item.title && item.title.trim() ? item.title.trim() : 'æœªå¡«å¯«';
                stats.titleCounts[title] = (stats.titleCounts[title] || 0) + 1;
                
                // 3. æœƒå‰æå•
                if (item.preQuestion && item.preQuestion.trim()) {
                    stats.questions.push({
                        name: item.name,
                        unit: item.unit,
                        question: item.preQuestion.trim(),
                        timestamp: item.timestamp,
                    });
                }
            });

            return stats;
        }

        /**
         * æ¸²æŸ“æ•¸æ“šç¸½è¦½å¡ç‰‡
         * @param {Object} stats - çµ±è¨ˆçµæœ
         */
        function renderSummary(stats) {
            if(document.getElementById('totalCount')) {
                document.getElementById('totalCount').textContent = stats.total;
            }
            if(document.getElementById('refreshmentsCount')) {
                document.getElementById('refreshmentsCount').textContent = stats.refreshmentsYes;
            }
            
            // ç”±æ–¼æ²’æœ‰å ±åé–‹å§‹æ™‚é–“æ•¸æ“šï¼Œå¹³å‡é€Ÿåº¦æš«æ™‚é¡¯ç¤ºç‚º N/A
            if(document.getElementById('averageSpeed')) {
                document.getElementById('averageSpeed').textContent = 'N/A';
            }
            
            // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
            if(document.getElementById('lastUpdated')) {
                document.getElementById('lastUpdated').textContent = formatDateTime(new Date());
            }
        }

        /**
         * æ¸²æŸ“è·ç¨±åˆ†ä½ˆåœ– (ä¿®æ­£ç‰ˆï¼šå®Œæ•´å‘ˆç¾æ‰€æœ‰è·ç¨±ä¸¦ç¢ºä¿åç¨±ä¸è¢«æˆªæ–·)
         * @param {Object} titleCounts - è·ç¨±çµ±è¨ˆçµæœ
         * @param {number} total - ç¸½äººæ•¸
         */
        function renderTitleChart(titleCounts, total) {
            const container = document.getElementById('titleChartContainer');
            if (!container) return;
            
            container.innerHTML = ''; // æ¸…é™¤ loading è¨Šæ¯

            if (total === 0) {
                container.innerHTML = '<p class="text-gray-500 text-lg">ç›®å‰å°šç„¡å ±åè³‡æ–™ã€‚</p>';
                return;
            }

            // 1. çµ±è¨ˆä¸¦æ’åºæ•¸æ“š (æ•¸é‡é™åºæ’åˆ—)
            const sortedTitles = Object.entries(titleCounts)
                .sort(([, countA], [, countB]) => countB - countA);
            
            // å®šç¾©ä¸€çµ„é¡è‰²å¾ªç’°
            const colors = ['#a855f7', '#ec4899', '#10b981', '#3b82f6', '#f97316', '#64748b', '#06b6d4', '#eab308']; 
            
            // 2. æ¸²æŸ“é•·æ¢åœ–
            sortedTitles.forEach(([title, count], index) => {
                // é•·æ¢å¯¬åº¦æ”¹ç‚ºä½”ç¸½å ±åäººæ•¸çš„ç™¾åˆ†æ¯”
                const barWidthPercentage = (count / total) * 100;
                const color = colors[index % colors.length];

                // **ä¿®æ­£é»ï¼šå°‡è·ç¨±æ¬„ä½å¯¬åº¦å¢åŠ åˆ° w-1/3 (ç´„ 33.3%)ï¼Œä¸¦ç§»é™¤ 'truncate' é¡ï¼Œç¢ºä¿å®Œæ•´é¡¯ç¤ºã€‚**
                const barHtml = `
                    <div class="flex items-center text-sm py-2">
                        <!-- è·ç¨±åç¨± (ä¿®æ­£ç‚º w-1/3ï¼Œç§»é™¤ truncate) -->
                        <div class="w-1/3 font-medium text-gray-800 mr-3 pr-1 flex-shrink-0" title="${title}">
                            ${title} 
                        </div>
                        <!-- é•·æ¢åœ–å®¹å™¨ -->
                        <div class="flex-grow">
                            <div class="h-6 rounded-full bg-gray-200">
                                <div style="width: ${barWidthPercentage > 0.5 ? barWidthPercentage : 0.5}%; background-color: ${color}; min-width: ${count > 0 ? '4px' : '0'};" 
                                     class="h-6 text-xs text-white flex items-center justify-end pr-2 rounded-full font-bold transition-all duration-500 ease-out shadow-md"
                                     title="${title}: ${count} äºº (${barWidthPercentage.toFixed(1)}%)">
                                    ${count} <span class="text-[10px] ml-1 opacity-80">(${barWidthPercentage.toFixed(1)}%)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', barHtml);
            });
        }
        
        /**
         * æ¸²æŸ“æœ€æ–°å ±ååˆ—è¡¨
         * @param {Array<Object>} latestEntries - æœ€æ–°å ±åæ•¸æ“š
         */
        function renderLatestRegistrations(latestEntries) {
            const listContainer = document.getElementById('latestRegistrations');
            if (!listContainer) return;

            listContainer.innerHTML = '';
            
            if (latestEntries.length === 0) {
                listContainer.innerHTML = '<li class="text-gray-500">ç›®å‰å°šç„¡å ±åè³‡æ–™ã€‚</li>';
                return;
            }

            latestEntries.forEach(item => {
                // ç¢ºä¿è·ç¨±éç©º
                const title = item.title && item.title.trim() ? item.title.trim() : 'æœªå¡«å¯«';
                
                const listItem = `
                    <li class="p-3 bg-purple-50 rounded-lg shadow-sm border-l-4 border-pink-400">
                        <p class="font-semibold text-gray-800">${item.name} <span class="text-xs font-normal text-pink-500 ml-1">(${title})</span></p>
                        <p class="text-xs text-gray-500">${item.unit}</p>
                        <p class="text-xs text-gray-400 mt-1">å ±åæ™‚é–“: ${formatDateTime(item.timestamp)}</p>
                    </li>
                `;
                listContainer.insertAdjacentHTML('beforeend', listItem);
            });
        }
        
        /**
         * æ¸²æŸ“æœƒå‰æå•åˆ—è¡¨
         * @param {Array<Object>} questions - æœƒå‰æå•æ•¸æ“š
         */
        function renderQuestions(questions) {
            const questionContainer = document.getElementById('preQuestionList');
            if (!questionContainer) return;
            
            questionContainer.innerHTML = '';

            if (questions.length === 0) {
                questionContainer.innerHTML = '<p class="text-gray-500">ç›®å‰æ²’æœ‰æœƒå‰æå•ã€‚</p>';
                return;
            }

            questions.forEach((q, index) => {
                const questionHtml = `
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm">
                        <p class="font-medium text-gray-800 italic">â€œ${q.question}â€</p>
                        <p class="text-xs text-gray-600 mt-2 text-right">
                            â€” ${q.name} (${q.unit})
                            <span class="ml-2 text-gray-400">${formatDateTime(q.timestamp)}</span>
                        </p>
                    </div>
                `;
                questionContainer.insertAdjacentHTML('beforeend', questionHtml);
            });
        }


        /**
         * ä¸»æ§å‡½å¼: ç²å–è³‡æ–™ä¸¦æ¸²æŸ“å„€è¡¨æ¿
         */
        async function fetchAndRenderDashboard() {
            // ç”±æ–¼ä¹‹å‰çš„éŒ¯èª¤ï¼Œåœ¨å˜—è©¦ç²å–è³‡æ–™ä¹‹å‰ï¼Œå…ˆè¨­ç½®è¼‰å…¥ç‹€æ…‹ï¼Œç¢ºä¿å…ƒç´ å­˜åœ¨
            const titleChartLoading = document.getElementById('titleChartLoading');
            const lastUpdated = document.getElementById('lastUpdated');

            if (titleChartLoading) titleChartLoading.textContent = 'æ­£åœ¨å¾ Google Sheets è¼‰å…¥æ•¸æ“š...';
            if (lastUpdated) lastUpdated.textContent = 'é€£ç·šä¸­...';

            if (DASHBOARD_WEB_APP_URL.includes('YOUR_DEPLOYED_DASHBOARD_WEB_APP_URL_HERE')) {
                if (titleChartLoading) titleChartLoading.textContent = 'ğŸš¨ è«‹å…ˆéƒ¨ç½² Code_Dashboard.gs ä¸¦æ›´æ–° URLï¼';
                return;
            }
            
            // åœ¨ Web App URL å¾Œé¢æ–°å¢æ™‚é–“æˆ³è¨˜ï¼Œå¹«åŠ©é¿å…å¿«å–å•é¡Œ
            const fetchUrl = `${DASHBOARD_WEB_APP_URL}?_=${new Date().getTime()}`;

            try {
                // å˜—è©¦ä½¿ç”¨ fetch API ç²å–æ•¸æ“šï¼Œä¸¦æ˜ç¢ºæŒ‡å®š mode: 'cors'
                const response = await fetch(fetchUrl, { mode: 'cors' }); 
                
                // æª¢æŸ¥ HTTP ç‹€æ…‹ç¢¼
                if (!response.ok) {
                    throw new Error(`HTTP éŒ¯èª¤! ç‹€æ…‹ç¢¼: ${response.status}`);
                }

                const result = await response.json();

                if (result.status === 'success') {
                    // å°‡è³‡æ–™åè½‰ï¼Œè®“æœ€æ–°çš„åœ¨å‰é¢ã€‚Apps Script çš„ data å¯èƒ½æ˜¯æœ€æ—©çš„åœ¨å‰é¢ã€‚
                    const rawData = result.data.reverse(); 
                    const stats = calculateStats(rawData);
                    
                    renderSummary(stats);
                    // å‘¼å«ä¿®æ­£å¾Œçš„å‡½å¼
                    renderTitleChart(stats.titleCounts, stats.total); 
                    renderLatestRegistrations(stats.latestEntries);
                    renderQuestions(stats.questions);
                    
                } else {
                    throw new Error(result.message || 'Apps Script å›å‚³éŒ¯èª¤ç‹€æ…‹ã€‚');
                }

            } catch (error) {
                console.error('å„€è¡¨æ¿è¼‰å…¥å¤±æ•—:', error);
                const errorMessage = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}ã€‚è«‹æª¢æŸ¥ Apps Script æ˜¯å¦å·²éƒ¨ç½²ã€URL æ˜¯å¦æ­£ç¢ºï¼Œä»¥åŠ Apps Script çš„ã€Œå­˜å–æ¬Šã€æ˜¯å¦è¨­å®šç‚ºã€Œæ‰€æœ‰äººã€ã€‚`;
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯åœ¨å„å€å¡Š (å¢åŠ å­˜åœ¨æª¢æŸ¥)
                if (document.getElementById('titleChartContainer')) {
                    document.getElementById('titleChartContainer').innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
                }
                if (document.getElementById('latestRegistrations')) {
                    document.getElementById('latestRegistrations').innerHTML = `<li class="text-red-500">${errorMessage}</li>`;
                }
                if (document.getElementById('preQuestionList')) {
                    document.getElementById('preQuestionList').innerHTML = `<p class="text-red-500">${errorMessage}</p>`;
                }
                if (lastUpdated) lastUpdated.textContent = 'è¼‰å…¥å¤±æ•—';
            }
        }

        // é é¢è¼‰å…¥æ™‚åŸ·è¡Œ
        window.onload = function() {
            // ç¢ºä¿å…ƒç´ å­˜åœ¨ï¼Œé å…ˆè¨­å®šè¼‰å…¥ç‹€æ…‹ï¼Œé¿å… 'Cannot set properties of null'
            if(document.getElementById('totalCount')) document.getElementById('totalCount').textContent = 'è¼‰å…¥ä¸­...';
            if(document.getElementById('refreshmentsCount')) document.getElementById('refreshmentsCount').textContent = 'è¼‰å…¥ä¸­...';
            if(document.getElementById('averageSpeed')) document.getElementById('averageSpeed').textContent = 'N/A';
            if(document.getElementById('lastUpdated')) document.getElementById('lastUpdated').textContent = 'é€£ç·šä¸­...';
            
            fetchAndRenderDashboard();
            // æ¯ 60 ç§’è‡ªå‹•æ›´æ–°ä¸€æ¬¡æ•¸æ“š
            setInterval(fetchAndRenderDashboard, 60000); 
        };
    </script>
</body>
</html>
